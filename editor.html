<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>AR Studio Lite – Editor</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; background:#0b0b0e; color:#e6e6f0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app { display:grid; grid-template-columns: 340px 1fr 360px; grid-template-rows: auto 1fr; grid-template-areas: "topbar topbar topbar" "left center right"; height:100vh; gap:8px; padding:8px; box-sizing:border-box; }
    .topbar { grid-area: topbar; display:flex; align-items:center; gap:10px; background:#11131a; border:1px solid #222635; border-radius:12px; padding:10px 12px; }
    .left { grid-area: left; background:#11131a; border:1px solid #222635; border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
    .center { grid-area: center; background:#0d0f16; border:1px solid #222635; border-radius:12px; position:relative; overflow:hidden; }
    .right { grid-area: right; background:#11131a; border:1px solid #222635; border-radius:12px; padding:10px; overflow:auto; }
    textarea { width:100%; height:240px; background:#0d0f16; color:#e6e6f0; border:1px solid #222635; border-radius:10px; padding:10px; box-sizing:border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .btn { background:#2a60ff; color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-block; }
    .btn.secondary { background:#1b1f2d; border:1px solid #2a3554; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:12px; color:#aab0c0; display:block; margin-bottom:6px; }
    input[type="text"], select { width:100%; background:#0d0f16; color:#e6e6f0; border:1px solid #222635; border-radius:8px; padding:8px; box-sizing:border-box; }
    .panel { background:#0d0f16; border:1px solid #222635; border-radius:10px; padding:10px; }
    canvas { width:100%; height:100%; display:block; }
    .links .btn { margin-right:6px; }
    .hint { color:#98a2b3; font-size:12px; }
    .status { position:fixed; right:10px; bottom:10px; background:#0d0f16; border:1px solid #222635; border-radius:10px; padding:8px 10px; color:#aab0c0; font:12px ui-monospace; max-width:48ch; z-index:20; display:none; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div style="font-weight:700">AR Studio Lite – Editor</div>
      <div style="flex:1"></div>
      <a class="btn secondary" href="index.html">Start</a>
    </div>

    <div class="left">
      <div class="panel">
        <label for="sceneJson">Szenen‑JSON</label>
        <textarea id="sceneJson" spellcheck="false"></textarea>
        <div class="row">
          <button class="btn" id="btnFormat">Formatieren</button>
          <button class="btn secondary" id="btnReset">Beispiel laden</button>
        </div>
      </div>
      <div class="panel">
        <label>Anchor</label>
        <div class="row">
          <select id="anchorType">
            <option value="image">image (Target)</option>
            <option value="surface">surface (Hit‑Test)</option>
          </select>
        </div>
        <label for="imageUrl" style="margin-top:8px;">Target‑Bild oder .mind</label>
        <input id="imageUrl" type="text" placeholder="https://.../card.png oder .../card.mind" />
      </div>
    </div>

    <div class="center">
      <canvas id="preview"></canvas>
    </div>

    <div class="right">
      <div class="panel">
        <label>Node</label>
        <input id="nodeId" type="text" placeholder="hero" />
        <label style="margin-top:8px;">Asset‑URL (GLB/GLTF)</label>
        <input id="assetUrl" type="text" placeholder="https://.../model.glb" />
        <label style="margin-top:8px;">Audio‑URL (optional)</label>
        <input id="audioUrl" type="text" placeholder="https://.../sound.mp3" />
      </div>

      <div class="panel">
        <label>Transform</label>
        <div class="row">
          <input id="pos" type="text" placeholder="pos: 0,0,0" />
          <input id="rot" type="text" placeholder="rot°: 0,0,0" />
          <input id="scl" type="text" placeholder="scl: 0.5,0.5,0.5" />
        </div>
      </div>

      <div class="panel links">
        <label>Veröffentlichen</label>
        <a class="btn" id="linkImg" href="#" target="_blank" rel="noopener">Image‑AR Viewer</a>
        <a class="btn" id="linkSurf" href="#" target="_blank" rel="noopener">Surface‑AR Viewer</a>
        <button class="btn secondary" id="btnQR">QR‑Code</button>
        <p class="hint" style="margin-top:8px;">Links werden live aktualisiert (keine Popups). QR öffnet Image/Surface abhängig vom Anchor.</p>
      </div>
    </div>
  </div>

  <div class="status" id="status"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.158.0/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js';

    const $ = (s)=>document.querySelector(s);
    const sceneJsonEl=$('#sceneJson'), anchorTypeEl=$('#anchorType'), imageUrlEl=$('#imageUrl');
    const nodeIdEl=$('#nodeId'), assetUrlEl=$('#assetUrl'), audioUrlEl=$('#audioUrl');
    const posEl=$('#pos'), rotEl=$('#rot'), sclEl=$('#scl');
    const linkImg=$('#linkImg'), linkSurf=$('#linkSurf'), statusEl=$('#status');

    const defaultScene = {
      meta:{name:"Demo",version:1},
      anchor:{type:"image",src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"},
      nodes:[{id:"hero",type:"model",src:"https://modelviewer.dev/shared-assets/models/Astronaut.glb",transform:{position:[0,0,0],rotation:[0,0,0],scale:[0.5,0.5,0.5]},behaviors:[{on:"onTap",action:"playSound",src:""}]}]
    };
    let data = structuredClone(defaultScene);

    // 3D Preview
    const canvas = $('#preview');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 100);
    camera.position.set(2.8, 1.6, 2.8);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0.6, 0); controls.update();
    const light = new THREE.HemisphereLight(0xffffff, 0x222244, 1.2); scene.add(light);
    const dir = new THREE.DirectionalLight(0xffffff, 1); dir.position.set(2,3,2); scene.add(dir);
    const grid = new THREE.GridHelper(10, 10, 0x334455, 0x223344); grid.position.y=0; scene.add(grid);
    const loader = new GLTFLoader();
    let model=null;
    const resize=()=>{ const w=canvas.clientWidth||canvas.parentElement.clientWidth; const h=canvas.clientHeight||canvas.parentElement.clientHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); };
    new ResizeObserver(resize).observe(canvas.parentElement);
    const render=()=>{ renderer.render(scene,camera); requestAnimationFrame(render); }; render();
    function loadModel(url){
      if(model){ scene.remove(model); }
      if(!url) return;
      loader.load(url, (gltf)=>{ model=gltf.scene; scene.add(model); applyTransform(); }, undefined, (e)=> showStatus('GLB Ladefehler: '+e.message) );
    }
    function applyTransform(){
      const n = data.nodes[0];
      if(!n||!model) return;
      const [px,py,pz]=(posEl.value||"0,0,0").split(',').map(Number);
      const [rx,ry,rz]=(rotEl.value||"0,0,0").split(',').map(Number);
      const [sx,sy,sz]=(sclEl.value||"0.5,0.5,0.5").split(',').map(Number);
      n.transform={position:[px,py,pz],rotation:[rx,ry,rz],scale:[sx,sy,sz]};
      model.position.set(px,py,pz);
      model.rotation.set(THREE.MathUtils.degToRad(rx),THREE.MathUtils.degToRad(ry),THREE.MathUtils.degToRad(rz));
      model.scale.set(sx,sy,sz);
      updateLinks();
    }
    function updateUI(){
      sceneJsonEl.value = JSON.stringify(data,null,2);
      anchorTypeEl.value = data.anchor?.type || 'image';
      imageUrlEl.value = data.anchor?.src || '';
      const n = data.nodes[0] || {};
      nodeIdEl.value = n.id || 'hero';
      assetUrlEl.value = n.src || '';
      const t = n.transform || {position:[0,0,0],rotation:[0,0,0],scale:[0.5,0.5,0.5]};
      posEl.value = t.position.join(',');
      rotEl.value = t.rotation.join(',');
      sclEl.value = t.scale.join(',');
      loadModel(n.src);
      updateLinks();
    }
    function fromUI(){
      data.anchor = data.anchor || {};
      data.anchor.type = anchorTypeEl.value;
      if (imageUrlEl.value.trim()) data.anchor.src = imageUrlEl.value.trim();
      const n = data.nodes[0] || (data.nodes[0]={id:'hero',type:'model',src:'',transform:{position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},behaviors:[]});
      n.id = nodeIdEl.value.trim() || 'hero';
      n.src = assetUrlEl.value.trim();
      const b = (n.behaviors||[]).find(x=>x.action==='playSound');
      if (audioUrlEl.value.trim()){
        if(b) b.src=audioUrlEl.value.trim();
        else (n.behaviors || (n.behaviors=[])).push({on:'onTap',action:'playSound',src:audioUrlEl.value.trim()});
      }
      applyTransform();
      sceneJsonEl.value = JSON.stringify(data,null,2);
    }
    function encodedScene(){
      return btoa(encodeURIComponent(JSON.stringify(data)));
    }
    function viewerUrl(which){
      const base = location.href.replace(/editor\.html?$/,''); // keep repo path
      return base + (which==='image' ? 'image-viewer.html' : 'surface-viewer.html') + '?scene=' + encodedScene();
    }
    function updateLinks(){
      linkImg.href = viewerUrl('image');
      linkSurf.href = viewerUrl('surface');
    }
    function showStatus(msg){ statusEl.textContent = msg; statusEl.style.display='block'; setTimeout(()=> statusEl.style.display='none', 4500); }

    // Events
    $('#btnFormat').onclick = ()=>{ try{ const o=JSON.parse(sceneJsonEl.value); sceneJsonEl.value=JSON.stringify(o,null,2); data=o; updateUI(); }catch(e){ showStatus('JSON Fehler: '+e.message); } };
    $('#btnReset').onclick = ()=>{ data = structuredClone(defaultScene); updateUI(); };
    [anchorTypeEl,imageUrlEl,nodeIdEl,assetUrlEl,audioUrlEl,posEl,rotEl,sclEl].forEach(el=> el.addEventListener('change', fromUI));

    // QR
    $('#btnQR').onclick = ()=>{
      const useImage = (data.anchor?.type!=='surface');
      const url = useImage ? viewerUrl('image') : viewerUrl('surface');
      const w = window.open('', '_blank');
      if(!w){ showStatus('Popup blockiert. Rechtsklick → Link kopieren oder Direktlink anklicken.'); return; }
      w.document.write('<!doctype html><meta charset=\"utf-8\"><title>QR</title><div id=qr></div><script src=\"https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\"></script><script>new QRCode(document.getElementById(\'qr\'),{text:'+JSON.stringify(url)+',width:280,height:280});</script>');
      w.document.close();
    };

    // Init
    data = structuredClone(defaultScene); updateUI(); resize();
  </script>
</body>
</html>
