<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>ARea – Image Tracking (local)</title>

  <!-- exakt so wie in deinem /lib -->
  <script src="./lib/aframe-v1.4.0.min.js"></script>
  <script src="./lib/mindar-image-aframe.prod.js"></script>

  <style>
    :root { color-scheme: dark; }
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .badge{position:fixed;top:10px;left:10px;z-index:40;background:rgba(0,0,0,.65);color:#fff;padding:6px 10px;border-radius:10px;font-size:12px}
    .btn{padding:10px 12px;border-radius:12px;background:#111;color:#fff;border:1px solid #333}
    #tap{position:fixed;inset:0;z-index:35;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
    #ui{position:fixed;top:10px;right:10px;z-index:40;display:flex;gap:8px}
    .hint{position:fixed;left:0;right:0;bottom:0;z-index:30;display:grid;place-items:center;padding:10px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.7));color:#eee;font-size:14px}
    .hint a{color:#a8d1ff;text-decoration:none}
  </style>
</head>
<body>
  <div id="status" class="badge">BOOTING…</div>
  <div id="tap"><button id="start" class="btn">AR STARTEN</button></div>
  <div id="ui"><button id="switchCam" class="btn">Kamera wechseln</button></div>

  <a-scene
    mindar-image="imageTargetSrc: ./demo/card.mind; autoStart: false;"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    renderer="colorManagement:true, physicallyCorrectLights:true">

    <a-assets timeout="60000">
      <img id="targetImg" src="./demo/card.png">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="marker" mindar-image-target="targetIndex:0">
      <a-box position="0 0 0.05" width="0.15" height="0.15" depth="0.15" color="#4CC3D9"
             animation="property: position; to: 0 0.18 0.05; dur: 900; dir: alternate; loop: true;"></a-box>
    </a-entity>
  </a-scene>

  <div class="hint">
    <div>• Kamera erlauben. Marker ruhig & komplett ins Bild (20–40 cm, diffuses Licht).</div>
    <div>• Testmarker: <a href="./demo/card.png" target="_blank" rel="noopener">card.png</a></div>
  </div>

  <script>
    const scene = document.querySelector('a-scene');
    const badge = document.getElementById('status');
    const tap = document.getElementById('tap');
    const btnStart = document.getElementById('start');
    const btnSwitch = document.getElementById('switchCam');
    let cams=[], camIndex=0, starting=false;

    // Autostart-Fallback (iOS)
    setTimeout(()=>{ if(badge.textContent.startsWith('BOOTING')) tap.style.display='flex'; },1200);

    async function listCameras(){
      try{
        await navigator.mediaDevices.getUserMedia({video:true,audio:false}).catch(()=>{});
        const devs = await navigator.mediaDevices.enumerateDevices();
        cams = devs.filter(d=>d.kind==='videoinput');
      }catch(e){ badge.textContent='Kamera blockiert'; }
    }

    async function startWith(deviceId,label){
      const sys = scene.systems['mindar-image-system'];
      if(!sys){ badge.textContent='START ERROR — MindAR-Script fehlt (404?)'; return; }
      if(starting) return; starting=true;
      try{
        if(sys._started||sys.started){ try{ await sys.stop(); }catch(_){} }
        try{ await sys.start({deviceId}); } catch { await sys.start({video:{deviceId:{exact:deviceId}}}); }
        tap.style.display='none';
        badge.textContent='AR READY — '+(label||'')+' scanne ./demo/card.png';
      }catch(e){
        console.error(e);
        badge.textContent='START ERROR — '+(e?.message||e);
        tap.style.display='flex';
      }finally{ starting=false; }
    }

    async function startPreferred(){
      await listCameras();
      if(!cams.length){ badge.textContent='Keine Kamera'; return; }
      const envIdx=cams.findIndex(c=>/back|rear|environment/i.test(c.label));
      camIndex=envIdx>=0?envIdx:0;
      await startWith(cams[camIndex].deviceId);
    }

    btnStart.addEventListener('click', startPreferred);
    btnSwitch.addEventListener('click', async ()=>{
      if(!cams.length) await listCameras();
      if(!cams.length) return;
      camIndex=(camIndex+1)%cams.length;
      const c=cams[camIndex];
      await startWith(c.deviceId,'wechsel: '+(c.label||('Cam '+camIndex)));
    });

    scene.addEventListener('arReady', ()=>{ if(!badge.textContent.includes('AR READY')) badge.textContent='AR READY — scanne ./demo/card.png'; });
    scene.addEventListener('arError', e=>{ tap.style.display='flex'; badge.textContent='AR ERROR — '+(e?.detail||'Unbekannt'); });

    // Pflichtdateien prüfen (zeigt konkrete 404)
    (async()=>{
      const base = location.pathname.replace(/\/[^/]*$/,'');
      const urls=[
        `${base}/lib/aframe-v1.4.0.min.js`,
        `${base}/lib/mindar-image-aframe.prod.js`,
        `${base}/lib/controller.worker.js`,
        `${base}/lib/opencv.js`,
        `${base}/lib/opencv-wasm.js`,
        `${base}/demo/card.mind`,
        `${base}/demo/card.png`,
      ];
      const results = await Promise.all(urls.map(u=>fetch(u,{cache:'no-store'}).then(r=>r.ok).catch(()=>false)));
      const bad = results.findIndex(ok=>!ok);
      if(bad>=0){ badge.textContent='FEHLT/404: '+urls[bad]; tap.style.display='flex'; }
    })();
  </script>
</body>
</html>
