<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR â€“ Image (MindAR mit Kamera-Wahl)</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);z-index:3;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button{background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:12px}
    #log{position:fixed;right:10px;bottom:10px;max-width:80vw;background:rgba(0,0,0,.6);color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.35 system-ui;white-space:pre-wrap;z-index:3}
    #picker{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:3;background:#111;border:1px solid #333;color:#ddd;border-radius:12px;padding:8px 10px;display:none;max-width:92vw}
    #picker label{display:block;margin:6px 0 4px;color:#aaa;font-size:12px}
    #picker select{width:72vw;max-width:520px;background:#0b0b0b;border:1px solid #333;color:#fff;border-radius:10px;padding:8px}
    #target{position:fixed;right:10px;top:10px;z-index:3;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
  </style>

  <!-- Nur MindAR UMD (liefert window.MINDAR.IMAGE + eigene THREE-Instanz) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="ui">
    <button id="start">ðŸš€ AR starten</button>
    <button id="pick">ðŸŽ¥ Kamera wÃ¤hlen</button>
    <button id="retry" style="display:none">ðŸ”„ Neu versuchen</button>
  </div>

  <div id="picker">
    <label for="cams">Kamera</label>
    <select id="cams"></select>
    <button id="useCam" style="margin-left:8px">Ãœbernehmen</button>
  </div>

  <div id="log"></div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img id="targetImg" width="140"/>
  </div>

<script>
const log = (m)=>{ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; };

async function ensureLabels(){
  try{ const s=await navigator.mediaDevices.getUserMedia({video:true}); s.getTracks().forEach(t=>t.stop()); }catch{}
}
async function listCameras(){
  const devs=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  devs.sort((a,b)=>{
    const ra=/back|rear|environment/i.test(a.label)?-1:0;
    const rb=/back|rear|environment/i.test(b.label)?-1:0;
    return ra-rb;
  });
  return devs;
}
async function showPicker(){
  await ensureLabels();
  const cams=await listCameras();
  const sel=document.getElementById('cams');
  sel.innerHTML='';
  const current=localStorage.getItem('webar.cameraId')||'';
  cams.forEach(d=>{
    const o=document.createElement('option');
    o.value=d.deviceId;
    o.textContent=d.label||`Kamera ${d.deviceId.slice(0,6)}â€¦`;
    if(d.deviceId===current) o.selected=true;
    sel.appendChild(o);
  });
  document.getElementById('picker').style.display='block';
}
document.getElementById('pick').onclick=showPicker;
document.getElementById('useCam').onclick=()=>{
  const id=document.getElementById('cams').value;
  if(id){ localStorage.setItem('webar.cameraId', id); log('âœ… Kamera gesetzt: '+document.getElementById('cams').selectedOptions[0].textContent); }
  document.getElementById('picker').style.display='none';
};

// Einen einzigen getUserMedia-Aufruf patchen, um deviceId/facingMode zu erzwingen
function patchNextGetUserMedia(opts){
  const orig=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
  let used=false;
  navigator.mediaDevices.getUserMedia=(constraints)=>{
    try{
      if(!used){
        const v = constraints?.video===true ? {} : (constraints?.video||{});
        const c = {...constraints, video: {...v} };
        if(opts?.deviceId) c.video.deviceId={ exact: opts.deviceId };
        else c.video.facingMode={ ideal:'environment' };
        c.video.width={ ideal:1280 }; c.video.height={ ideal:720 };
        constraints=c; used=true;
      }
    }catch{}
    const p=orig(constraints);
    p.finally(()=>{ navigator.mediaDevices.getUserMedia=orig; });
    return p;
  };
}

let mindar=null;

async function loadConfig(){
  const qs=new URLSearchParams(location.search);
  const url=qs.get('project');
  if(!url){
    return {
      anchor:{ type:"image", targets:[{
        src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/exa
