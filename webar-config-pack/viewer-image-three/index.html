<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR ‚Äì Image (MindAR + Three)</title>

  <!-- Polyfill zuerst, ohne async, damit er sicher aktiv ist -->
  <script src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>

  <!-- Import-Map (f√ºr native Browser) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <!-- Import-Map f√ºr den Polyfill -->
  <script type="importmap-shim">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:3}
    #start{background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:12px}
    #log{position:fixed;right:10px;bottom:10px;max-width:70vw;background:rgba(0,0,0,.6);color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.3 system-ui;white-space:pre-wrap;z-index:3}
    #target{position:fixed;right:10px;top:10px;z-index:3;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
  </style>
</head>
<body>
  <div id="ui"><button id="start">üöÄ AR starten</button></div>
  <div id="log"></div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img id="targetImg" width="120" height="66"/>
  </div>

  <!-- Wichtig: module-shim damit der Polyfill sicher greift -->
  <script type="module-shim">
    import * as THREE from "three";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
    import { MindARThree } from "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js";

    const log = (m)=>{ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; };

    async function loadConfig(){
      const qs = new URLSearchParams(location.search);
      const url = qs.get('project');
      if(!url){
        return {
          name: "Demo Image",
          anchor: { type: "image", targets: [ {
            src: "https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind",
            preview: "https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
          } ]},
          nodes: [{
            id:"model",
            asset:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf",
            transform:{ position:[0,0,0.1], rotation:[0,0,0], scale:[0.005,0.005,0.005] }
          }]
        };
      }
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('Config laden fehlgeschlagen: '+res.status);
      return res.json();
    }

    let started = false;
    document.getElementById('start').onclick = async ()=>{
      if(started) return; started = true;
      document.getElementById('start').style.display='none';

      try{
        const cfg = await loadConfig();
        if(cfg.anchor?.type !== 'image') throw new Error('Config anchor.type muss "image" sein');
        const targetSrc = cfg.anchor.targets?.[0]?.src;
        if(!targetSrc) throw new Error('anchor.targets[0].src (.mind) fehlt');

        const prev = cfg.anchor.targets?.[0]?.preview;
        if(prev){ const box=document.getElementById('target'); box.style.display='block'; document.getElementById('targetImg').src=prev; }

        const mindar = new MindARThree({
          container: document.body,
          imageTargetSrc: targetSrc,
          uiLoading: true, uiError: true, maxTrack: 1
        });
        const {renderer, scene, camera} = mindar;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

        const anchor = mindar.addAnchor(0);
        const loader = new GLTFLoader();
        for(const n of (cfg.nodes||[])){
          await new Promise((resolve,reject)=>{
            loader.load(n.asset, (gltf)=>{
              const o = gltf.scene || gltf.scenes?.[0];
              const p=n.transform?.position||[0,0,0], r=n.transform?.rotation||[0,0,0], s=n.transform?.scale||[1,1,1];
              o.position.set(...p); o.rotation.set(...r); o.scale.set(...s);
              anchor.group.add(o); resolve();
            }, undefined, reject);
          });
        }

        await mindar.start();
        // Debug nach dem Start, wenn das Video existiert
        const iv = setInterval(()=>{
          const v = mindar.video;
          if(v && v.videoWidth){ log(`üìπ Video ${v.videoWidth}x${v.videoHeight}`); clearInterval(iv); }
        }, 400);

        log("‚úÖ MindAR gestartet");
        renderer.setAnimationLoop(()=> renderer.render(scene, camera));
      }catch(e){ log('‚ùå '+e.message); }
    };
  </script>
</body>
</html>
