<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR ‚Äì Image (Kamera fix & Picker)</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:76px;transform:translateX(-50%);z-index:9999;display:flex;gap:8px;flex-wrap:wrap}
    button{background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:12px}
    #log{position:fixed;right:10px;bottom:10px;max-width:80vw;background:rgba(0,0,0,.7);color:#fff;padding:10px 12px;border-radius:12px;font:12px/1.35 system-ui;white-space:pre-wrap;z-index:9999}
    #target{position:fixed;right:10px;top:10px;z-index:9999;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
    #picker{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:9999;background:#111;border:1px solid #333;color:#ddd;border-radius:12px;padding:8px 10px;display:none}
    #picker select{min-width:280px;max-width:70vw;background:#0b0b0b;border:1px solid #333;color:#fff;border-radius:10px;padding:8px}
    /* echtes Kameravideo hinter Canvas */
    video#cameraFeed{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:0}
    canvas{position:fixed;inset:0;z-index:1}
  </style>
  <!-- Nur MindAR UMD (liefert window.MINDAR.IMAGE + THREE) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="ui">
    <button id="start">üöÄ AR starten</button>
    <button id="choose">üé• Kamera w√§hlen</button>
    <button id="next" style="display:none">‚û°Ô∏è N√§chste Kamera</button>
  </div>
  <div id="picker">
    <select id="cams"></select>
    <button id="use">√úbernehmen</button>
  </div>
  <div id="log">‚è≥ Bereit. Tippe ‚ÄûAR starten‚Äú.</div>
  <div id="target"><div style="color:#bbb;font:12px;margin-bottom:4px">Target Preview:</div><img id="targetImg" width="140"/></div>

<script>
const log = (m)=>{ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; };

let devices=[], deviceIdx=0, mindar=null;

async function ensureLabels(){ try{ const s=await navigator.mediaDevices.getUserMedia({video:true}); s.getTracks().forEach(t=>t.stop()); }catch{} }
async function enumerateCams(){
  await ensureLabels();
  devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  devices.sort((a,b)=>{ // back/environment zuerst
    const ra=/back|rear|environment/i.test(a.label)?-1:0;
    const rb=/back|rear|environment/i.test(b.label)?-1:0;
    return ra-rb;
  });
  const saved = localStorage.getItem('webar.cameraId');
  if(saved){ const i = devices.findIndex(d=>d.deviceId===saved); if(i>=0) deviceIdx=i; }
}
function fillPicker(){
  const sel = document.getElementById('cams'); sel.innerHTML='';
  devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d.label||`Kamera ${d.deviceId.slice(0,6)}‚Ä¶`; if(i===deviceIdx) o.selected=true; sel.appendChild(o); });
}
function showPicker(){ fillPicker(); document.getElementById('picker').style.display='block'; }
async function useSelected(){
  deviceIdx = parseInt(document.getElementById('cams').value,10)||0;
  const d = devices[deviceIdx];
  localStorage.setItem('webar.cameraId', d.deviceId);
  document.getElementById('picker').style.display='none';
  log('‚úÖ Bevorzugte Kamera: '+(d.label||d.deviceId));
  await startWithCurrentDevice(); // <‚Äî NEU: direkt anwenden!
}
function patchNextGUM(deviceId){
  const orig=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices); let used=false;
  navigator.mediaDevices.getUserMedia=(constraints)=>{
    if(!used){
      const v = constraints?.video===true ? {} : (constraints?.video||{});
      constraints={...constraints, video:{...v, deviceId:{exact:deviceId}, width:{ideal:1280}, height:{ideal:720}}};
      used=true;
    }
    const p=orig(constraints); p.finally(()=>{ navigator.mediaDevices.getUserMedia=orig; }); return p;
  };
}

async function startWithCurrentDevice(){
  const M = window.MINDAR?.IMAGE; if(!M?.MindARThree){ log('‚ùå MindAR UMD fehlt'); return; }
  const { MindARThree, THREE } = M;

  // Config laden (Fallback)
  const qs = new URLSearchParams(location.search);
  const url = qs.get('project');
  let cfg;
  if(!url){
    cfg={anchor:{type:"image",targets:[{src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind",preview:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"}]},nodes:[{id:"cube",transform:{position:[0,0,0.1],rotation:[0,0,0],scale:[0.15,0.15,0.15]}}]};
  }else{
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('Config '+r.status); cfg=await r.json();
  }
  const target = cfg.anchor?.targets?.[0]; if(target?.preview){ document.getElementById('target').style.display='block'; targetImg.src=target.preview; }

  if(mindar){ try{ await mindar.stop(); }catch{} mindar=null; }

  const dev = devices[deviceIdx]; if(!dev){ log('‚ùå keine Kameras gefunden'); return; }
  patchNextGUM(dev.deviceId); log('üé• erzwinge: '+(dev.label||dev.deviceId));

  mindar = new MindARThree({ container: document.body, imageTargetSrc: target.src, uiLoading:true, uiError:true, maxTrack:1 });
  const { renderer, scene, camera } = mindar;
  renderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
  renderer.setClearColor(0x000000, 0); // <‚Äî Canvas transparent
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

  await mindar.start();

  // Video wirklich sichtbar hinter Canvas
  const v = mindar.video;
  if(v){
    v.id='cameraFeed'; v.playsInline=true; v.muted=true;
    if(!document.getElementById('cameraFeed')) document.body.prepend(v);
    log(`üìπ Stream: ${v.videoWidth||0}√ó${v.videoHeight||0}`);
    // genutzte deviceId/Label
    const track=v.srcObject?.getVideoTracks?.()[0];
    const set=track?.getSettings?.(); const devId=set?.deviceId;
    if(devId && devId!==dev.deviceId) log('‚ö†Ô∏è Browser hat andere Kamera gew√§hlt');
  }

  document.getElementById('next').style.display = devices.length>1 ? 'inline-block':'none';
  renderer.setAnimationLoop(()=> renderer.render(scene, camera));
}

async function startFlow(){ document.getElementById('start').disabled=true; await enumerateCams(); await startWithCurrentDevice(); log('‚úÖ MindAR l√§uft ‚Äì scanne den Marker'); }
async function nextCamera(){ deviceIdx=(deviceIdx+1)%devices.length; localStorage.setItem('webar.cameraId', devices[deviceIdx].deviceId); log('üîÅ Wechsel zu: '+(devices[deviceIdx].label||devices[deviceIdx].deviceId)); await startWithCurrentDevice(); }

// UI
document.getElementById('start').onclick=startFlow;
document.getElementById('choose').onclick=async ()=>{ await enumerateCams(); showPicker(); };
document.getElementById('use').onclick=useSelected;
document.getElementById('next').onclick=nextCamera;

// aufr√§umen
window.addEventListener('pagehide', async ()=>{ if(mindar){ try{ await mindar.stop(); }catch{} }});
document.addEventListener('visibilitychange', async ()=>{ if(document.hidden && mindar){ try{ await mindar.stop(); }catch{} }});
</script>
</body>
</html>
