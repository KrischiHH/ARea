<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR ‚Äì Image (Minimal, sicherer Start)</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);z-index:9999;pointer-events:auto}
    #start{background:#111;border:1px solid #333;color:#fff;padding:12px 16px;border-radius:14px;font-size:16px}
    #log{position:fixed;right:10px;bottom:10px;max-width:85vw;background:rgba(0,0,0,.7);color:#fff;
         padding:10px 12px;border-radius:12px;font:12px/1.35 system-ui;white-space:pre-wrap;z-index:9999}
    #target{position:fixed;right:10px;top:10px;z-index:9999;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
  </style>

  <!-- Nur MindAR UMD (liefert window.MINDAR.IMAGE + THREE) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="ui"><button id="start" onclick="startAR()">üöÄ AR starten</button></div>
  <div id="log">‚è≥ Bereit. Tippe ‚ÄûAR starten‚Äú.</div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img id="targetImg" width="140"/>
  </div>

<script>
function log(m){ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; }
function patchNextGUMForDevice(id){
  const orig=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
  let used=false;
  navigator.mediaDevices.getUserMedia=(constraints)=>{
    if(!used){
      const v = constraints?.video===true ? {} : (constraints?.video||{});
      constraints = {...constraints, video:{...v, deviceId:{exact:id}, width:{ideal:1280}, height:{ideal:720}}};
      used=true;
    }
    const p=orig(constraints);
    p.finally(()=>{ navigator.mediaDevices.getUserMedia=orig; });
    return p;
  };
}

async function loadConfig(){
  try{
    const qs=new URLSearchParams(location.search);
    const url=qs.get('project');
    if(!url){
      return {
        anchor:{ type:"image", targets:[{
          src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind",
          preview:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
        }]},
        nodes:[{ id:"cube", transform:{ position:[0,0,0.1], rotation:[0,0,0], scale:[0.15,0.15,0.15] } }]
      };
    }
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('Config '+r.status);
    return r.json();
  }catch(e){ log('‚ùå Config-Fehler: '+(e.message||e)); throw e; }
}

window.startAR = async function(){
  try{
    document.getElementById('start').disabled = true;
    log('‚ñ∂Ô∏è Start gedr√ºckt');

    const M = window.MINDAR?.IMAGE;
    if(!M?.MindARThree){ log('‚ùå MindAR UMD nicht geladen'); return; }
    const { MindARThree, THREE } = M;

    const cfg = await loadConfig();
    const t = cfg.anchor?.targets?.[0]; 
    if(!t?.src){ log('‚ùå anchor.targets[0].src (.mind) fehlt'); return; }

    if(t.preview){ document.getElementById('target').style.display='block'; document.getElementById('targetImg').src=t.preview; }

    // bevorzugte Kamera aus dem Camera-Checker erzwingen
    const pref = localStorage.getItem('webar.cameraId');
    if(pref){ log('üé• bevorzugte Kamera: '+pref.slice(0,8)+'‚Ä¶'); patchNextGUMForDevice(pref); }
    else { log('‚ÑπÔ∏è keine bevorzugte Kamera gesetzt (verwende Browser-Standard)'); }

    const mindar = new MindARThree({ container: document.body, imageTargetSrc: t.src, uiLoading:true, uiError:true, maxTrack:1 });
    const { renderer, scene, camera } = mindar;
    scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

    const anchor = mindar.addAnchor(0);
    const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({metalness:0.1, roughness:0.6}));
    anchor.group.add(cube);

    log('üì∏ Kamera wird ge√∂ffnet‚Ä¶');
    await mindar.start();
    const v = mindar.video;
    if(v){ log(`üìπ Stream: ${v.videoWidth}√ó${v.videoHeight}`); }
    log('‚úÖ MindAR l√§uft ‚Äì halte den Beispiel-Marker in die Kamera');

    renderer.setAnimationLoop(()=> renderer.render(scene, camera));

  }catch(e){
    log('‚ùå '+(e?.name||'')+' '+(e?.message||e));
    document.getElementById('start').disabled = false;
  }
};
</script>
</body>
</html>
