<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Camera Checker</title>
  <style>
    :root{color-scheme:dark}
    body{margin:0;background:#0b0b0b;color:#eee;font:14px/1.4 system-ui,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;background:#0b0b0b;padding:12px 16px;border-bottom:1px solid #222;z-index:2}
    .row{display:flex;flex-wrap:wrap;gap:16px;padding:16px}
    .card{flex:1 1 340px;max-width:520px;background:#111;border:2px solid #fff;border-radius:14px;overflow:hidden;position:relative}
    .card h3{margin:0;padding:10px 12px;font-size:14px;background:#151515;border-bottom:1px solid #222}
    .video-wrap{position:relative;background:#000}
    video{display:block;width:100%;height:280px;object-fit:cover;background:#000}
    .meta{display:flex;gap:10px;align-items:center;padding:8px 12px;border-top:1px solid #222}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #333;background:#181818}
    .ok{border-color:#264a1f;background:#183018;color:#9ff48a}
    .err{border-color:#5a2222;background:#2a1515;color:#ff9b9b}
    .btn{margin-left:auto;background:#111;border:1px solid #333;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#151515}
    .controls{display:flex;gap:8px;align-items:center;margin-top:6px}
    small{opacity:.8}
  </style>
</head>
<body>
  <header>
    <strong>Camera Checker</strong>
    <div class="controls">
      <button id="refresh" class="btn">üîÉ Neu scannen</button>
      <button id="stopAll" class="btn">‚èπÔ∏è Alle stoppen</button>
      <small id="hint">Tipp: Schlie√üe andere Kamera-/AR-Tabs (z. B. Surface), sonst ‚ÄûDevice in use‚Äú.</small>
    </div>
  </header>

  <section id="grid" class="row"></section>

  <script>
  const grid = document.getElementById('grid');
  const streams = new Map(); // deviceId -> MediaStream

  async function ensurePermission(){
    try{
      const tmp = await navigator.mediaDevices.getUserMedia({video:true});
      tmp.getTracks().forEach(t=>t.stop());
    }catch(e){
      console.warn('Permission check:', e);
    }
  }

  function stopStream(deviceId){
    const s = streams.get(deviceId);
    if(s){ s.getTracks().forEach(t=>t.stop()); streams.delete(deviceId); }
  }
  function stopAll(){ [...streams.keys()].forEach(stopStream); }
  document.getElementById('stopAll').onclick = stopAll;

  function setDefault(deviceId, label){
    localStorage.setItem('webar.cameraId', deviceId);
    alert('Standard-Kamera gesetzt:\n' + (label || deviceId));
  }

  function cardTemplate(d){
    const id = d.deviceId || 'no-id';
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <h3>${d.label || 'Kamera ' + id.slice(0,6) + '‚Ä¶'}</h3>
      <div class="video-wrap">
        <video id="vid-${id}" playsinline muted></video>
      </div>
      <div class="meta">
        <span class="pill" id="res-${id}">‚Äî</span>
        <span class="pill" id="stat-${id}">init‚Ä¶</span>
        <button class="btn" id="use-${id}">Als Standard speichern</button>
      </div>
    `;
    return el;
  }

  async function startPreview(d){
    const id = d.deviceId;
    const v = document.getElementById('vid-' + id);
    const res = document.getElementById('res-' + id);
    const stat = document.getElementById('stat-' + id);
    const useBtn = document.getElementById('use-' + id);

    useBtn.onclick = ()=> setDefault(id, d.label);

    // Vorherigen Stream (falls vorhanden) stoppen
    stopStream(id);

    try{
      const constraints = {
        video: {
          deviceId: { exact: id },
          width: { ideal: 1280 },
          height:{ ideal: 720 }
        },
        audio: false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      streams.set(id, stream);
      v.srcObject = stream;
      await v.play().catch(()=>{});
      await new Promise(r => v.onloadedmetadata ? (v.onloadedmetadata = r) : setTimeout(r,100));

      const w = v.videoWidth || 0, h = v.videoHeight || 0;
      res.textContent = w && h ? `${w}√ó${h}` : '‚Äî';
      res.classList.add(w && h ? 'ok' : 'err');
      stat.textContent = 'l√§uft';
      stat.classList.add('ok');
    }catch(e){
      console.error('Preview error for', id, e);
      stat.textContent = (e && e.name) ? e.name : 'Fehler';
      stat.classList.add('err');
    }
  }

  async function scan(){
    stopAll();
    grid.innerHTML = '';
    await ensurePermission();

    let devices = await navigator.mediaDevices.enumerateDevices();
    devices = devices.filter(d => d.kind === 'videoinput');

    if(!devices.length){
      const note = document.createElement('div');
      note.style.cssText = 'color:#ff9b9b;padding:16px';
      note.textContent = 'Keine Kameras gefunden.';
      grid.appendChild(note);
      return;
    }

    // Sortiere: ‚Äûback/rear/environment‚Äú zuerst
    devices.sort((a,b)=>{
      const ra = /back|rear|environment/i.test(a.label) ? -1 : 0;
      const rb = /back|rear|environment/i.test(b.label) ? -1 : 0;
      return ra - rb;
    });

    for(const d of devices){
      const card = cardTemplate(d);
      grid.appendChild(card);
      startPreview(d);
    }
  }

  document.getElementById('refresh').onclick = scan;

  // Beim Verlassen alles stoppen
  window.addEventListener('pagehide', stopAll);
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopAll(); });

  // Start
  scan();
  </script>
</body>
</html>
