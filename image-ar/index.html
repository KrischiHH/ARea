<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Image AR â€“ A-Frame + MindAR (Model, Overlay, Audio)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui;color:#fff}
  /* Ebenen: Video (0) â†’ Canvas (1) â†’ UI/Overlay (2) */
  #videoLayer{position:fixed;inset:0;z-index:0;display:block}
  #videoLayer video{position:absolute;inset:0;width:100vw;height:100dvh;object-fit:cover}
  a-scene{position:fixed;inset:0;z-index:1}
  #ui{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:flex-end;padding:12px;z-index:2}
  #log{position:fixed;left:12px;top:12px;z-index:2;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;font:12px/1.3 monospace}
  button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
  /* Overlay (klein, nicht blockierend) */
  #hint{position:fixed;right:12px;top:12px;z-index:2;pointer-events:none}
  #hint img{width:160px;height:auto;border-radius:10px;opacity:.9;display:block}
</style>
<!-- A-Frame + MindAR + Animation-Mixer -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/components/animation-mixer.min.js"></script>
</head>
<body>
  <!-- 0) Kamera-Video (DOM) -->
  <div id="videoLayer"></div>

  <!-- 1) A-Frame Szene (transparent, damit das Video sichtbar ist) -->
  <a-scene
    mindar-image="imageTargetSrc: ../assets/targets/target.mind?v=11; uiScanning: true; uiLoading: true"
    embedded
    renderer="alpha:true; antialias:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true">
    <a-assets>
      <!-- GLB + Audio hier anpassen -->
      <a-asset-item id="model" src="../assets/models/yourmodel.glb"></a-asset-item>
      <audio id="music" src="../assets/audio/loop.mp3"></audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- 3D-Content auf dem Marker -->
    <a-entity id="marker" mindar-image-target="targetIndex: 0">
      <!-- GLB mit Animation -->
      <a-gltf-model id="gmod" src="#model" position="0 0 0.1" rotation="0 0 0" scale="0.2 0.2 0.2"
                    animation-mixer="clip: *; timeScale: 1; crossFadeDuration: 0.2"></a-gltf-model>
      <!-- Optionaler Klang (wird per Button gestartet) -->
      <a-entity id="audio" sound="src: #music; autoplay: false; loop: true"></a-entity>
      <!-- Fallback (falls GLB fehlt) â€“ kleine Box -->
      <a-box id="fallback" position="0 0 0" depth="0.4" height="0.4" width="0.4" color="#4FC3F7" visible="false"></a-box>
    </a-entity>
  </a-scene>

  <!-- 2) UI + Overlay -->
  <div id="hint"><img src="../targets/target.png" alt="Referenzbild"></div>
  <div id="log">Bereitâ€¦</div>
  <div id="ui">
    <button id="btnAudio">ðŸ”Š Ton</button>
    <button id="btnSwitch">Kamera wechseln</button>
  </div>

<script>
  const log = t=>{ const el=document.getElementById('log'); el.textContent=t; console.log(t); };

  // Kamera-Video aus MindAR nach DOM ziehen (Fix gegen schwarzen Hintergrund)
  const sceneEl = document.querySelector('a-scene');
  const layer   = document.getElementById('videoLayer');

  function attachVideoWhenReady(){
    const v = document.getElementById('mindar-image-video') || document.querySelector('video');
    if (!v) { requestAnimationFrame(attachVideoWhenReady); return; }
    v.setAttribute('playsinline',''); v.muted = true; v.autoplay = true;
    if (v.parentElement !== layer){ layer.innerHTML=''; layer.appendChild(v); }
    v.style.position='absolute'; v.style.inset='0'; v.style.width='100vw'; v.style.height='100dvh'; v.style.objectFit='cover';
    log('Video gebunden');
  }
  sceneEl.addEventListener('arReady', attachVideoWhenReady);
  window.addEventListener('DOMContentLoaded', ()=>setTimeout(attachVideoWhenReady, 800));

  // Marker-Events: Overlay ein/aus, Animation pausieren/fortsetzen
  const marker   = document.getElementById('marker');
  const hint     = document.getElementById('hint');
  const gmod     = document.getElementById('gmod');
  const fallback = document.getElementById('fallback');
  const audioEnt = document.getElementById('audio');

  marker.addEventListener('targetFound', ()=>{
    hint.style.display = 'none';
    // Animation weiterlaufen lassen
    if (gmod.components['animation-mixer']) {
      gmod.setAttribute('animation-mixer', 'timeScale: 1');
    }
    log('targetFound');
  });
  marker.addEventListener('targetLost', ()=>{
    hint.style.display = 'block';
    // Animation pausieren
    if (gmod.components['animation-mixer']) {
      gmod.setAttribute('animation-mixer', 'timeScale: 0');
    }
    log('targetLost');
  });

  // GLB-Fallback: wenn Modell nicht lÃ¤dt â†’ Box sichtbar
  gmod.addEventListener('model-error', ()=>{ fallback.setAttribute('visible', true); });
  gmod.addEventListener('model-loaded', ()=>{ fallback.setAttribute('visible', false); });

  // Buttons: Ton & Kamera wechseln
  document.getElementById('btnAudio').addEventListener('click', ()=>{
    try{
      const s = audioEnt.components.sound;
      if (!s) return;
      if (s.isPlaying){ s.pauseSound(); } else { s.playSound(); }
    }catch(e){ console.warn(e); }
  });
  document.getElementById('btnSwitch').addEventListener('click', async ()=>{
    try{
      await sceneEl.systems['mindar-image-system'].switchCamera();
      // MindAR erstellt nach dem Switch ggf. ein neues <video> â†’ erneut anhÃ¤ngen
      setTimeout(attachVideoWhenReady, 300);
      log('Kamera gewechselt');
    }catch(e){ log('switchCamera error: '+e); }
  });
</script>
</body>
</html>
