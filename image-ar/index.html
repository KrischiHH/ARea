<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Image AR – MindAR + Three (fixed container)</title>
<style>
  :root{color-scheme:dark}
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui;overflow:hidden}
  /* Vollbild-Container NUR für MindAR (Video + Canvas) */
  #app{
    position:fixed; inset:0;
    width:100vw; height:100dvh;   /* dynamic viewport height = keine „Adressleisten“-Lücken */
    overflow:hidden; z-index:0;
  }
  /* UI oben drauf */
  #ui{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:flex-end;padding:12px;z-index:20}
  #log{position:fixed;left:12px;top:12px;z-index:20;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;font:12px/1.3 monospace}
  #hint{position:fixed;right:12px;top:12px;z-index:10;pointer-events:none}
  #hint img{width:160px;border-radius:10px;opacity:.9}
  button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
</style>

<!-- Polyfill synchron, dann Import Map -->
<script src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js" crossorigin="anonymous"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
  }
}
</script>
</head>
<body>
  <!-- >>> MindAR rendert in diesen Container (Video + Canvas) <<< -->
  <div id="app"></div>

  <div id="log">Bereit…</div>
  <div id="ui">
    <button id="start">Start AR</button>
    <button id="switch" disabled>Kamera wechseln</button>
  </div>
  <div id="hint">
    <img src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" alt="Referenzbild">
  </div>

<script type="module">
  import * as THREE from 'three';
  import { MindARThree } from 'mindar-image-three';

  const log = (t)=>{ document.getElementById('log').textContent=t; console.log(t); };

  const container = document.getElementById('app');
  const mindarThree = new MindARThree({
    container,
    // erst mit Known-Good target testen:
    imageTargetSrc: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind'
    // danach auf DEIN Target wechseln:
    // imageTargetSrc: '../assets/targets/target.mind?v=8'
  });

  const { renderer, scene, camera } = mindarThree;
  // Renderer exakt auf Containermaß setzen
  const resize = ()=>{
    const w = container.clientWidth;
    const h = container.clientHeight;
    renderer.setSize(w, h, false);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.setClearColor(0x000000, 0);
  };
  resize();

  // Licht
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));
  const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(0,6,0); scene.add(dir);

  // Anchor + Demo
  const anchor = mindarThree.addAnchor(0);
  const cube = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshNormalMaterial());
  anchor.group.add(cube);
  anchor.onTargetFound = ()=>{ document.getElementById('hint').style.display='none'; log('targetFound'); };
  anchor.onTargetLost  = ()=>{ document.getElementById('hint').style.display='block'; log('targetLost'); };

  // Start + Kamerawechsel
  const startBtn = document.getElementById('start');
  const switchBtn = document.getElementById('switch');

  startBtn.addEventListener('click', async ()=>{
    try{
      startBtn.disabled = true;
      await mindarThree.start();
      switchBtn.disabled = false;
      renderer.setAnimationLoop(()=>renderer.render(scene, camera));
      log('AR gestartet');
    }catch(e){ log('Start-Fehler: '+e); alert('Start fehlgeschlagen: '+e); startBtn.disabled=false; }
  });

  switchBtn.addEventListener('click', async ()=>{
    try{ await mindarThree.switchCamera(); log('gewechselt'); }catch(e){ log('switchCamera error: '+e); }
  });

  addEventListener('resize', resize);
</script>
</body>
</html>
