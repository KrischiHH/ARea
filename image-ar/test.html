<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Image AR – MindAR + Three (stable)</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui}
    #ui{position:fixed;inset:auto 0 0 0;display:flex;gap:8px;justify-content:flex-end;padding:12px;z-index:20}
    #log{position:fixed;left:12px;top:12px;z-index:20;background:rgba(0,0,0,.55);padding:8px 10px;border-radius:8px;max-width:80vw;font:12px/1.3 monospace;white-space:pre-wrap}
    #hint{position:fixed;inset:0;display:grid;place-items:center;z-index:10;
          background:linear-gradient(180deg,rgba(0,0,0,.28),rgba(0,0,0,.18)); pointer-events:none}
    #hint .card{pointer-events:auto; max-width:min(90vw,420px); background:rgba(255,255,255,.06);
          border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:12px}
    #hint img{display:block; width:100%; height:auto; border-radius:12px; opacity:.9}
    button{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
  </style>

  <!-- Wichtig: Polyfill SYNC laden (ohne async), dann Importmap, dann Module -->
  <script src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js" crossorigin="anonymous"></script>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>
</head>
<body>
  <div id="log">Bereit…</div>
  <div id="ui">
    <button id="start">Start AR</button>
    <button id="switch" disabled>Kamera wechseln</button>
  </div>

  <!-- dezentes Vorschau-Overlay (klein, klicks gehen trotzdem zu den Buttons) -->
  <div id="hint">
    <div class="card">
      <!-- Nimm dein eigenes Referenzbild, wenn du willst: ../targets/target.png -->
      <img src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" alt="Referenzbild">
      <p style="margin:.5rem 0 0;opacity:.85">Suche dieses Bild und richte die Kamera darauf.</p>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-image-three';

    const log = (...a)=>{ const el=document.getElementById('log'); el.textContent=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); console.log(...a); };

    // ERST mit dem CDN-Target testen. Läuft es? Dann unten auf dein target.mind umstellen.
    const mindarThree = new MindARThree({
      container: document.body,
      imageTargetSrc: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind'
      // => Wenn ok: auf dein Target wechseln:
      // imageTargetSrc: '../assets/targets/target.mind?v=5'
    });

    const { renderer, scene, camera } = mindarThree;
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.setClearColor(0x000000, 0);

    // Licht
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));
    const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(0,6,0); scene.add(dir);

    // Anchor + Demo-Objekt
    const anchor = mindarThree.addAnchor(0);
    const cube = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshNormalMaterial());
    anchor.group.add(cube);
    anchor.onTargetFound = ()=>{ document.getElementById('hint').style.display='none'; log('targetFound'); };
    anchor.onTargetLost  = ()=>{ document.getElementById('hint').style.display='grid'; log('targetLost'); };

    // Start via User-Gesture
    const startBtn = document.getElementById('start');
    const switchBtn = document.getElementById('switch');

    startBtn.addEventListener('click', async ()=>{
      try{
        startBtn.disabled = true;
        await mindarThree.start();          // Kamera + Tracking starten
        switchBtn.disabled = false;
        renderer.setAnimationLoop(()=>{ renderer.render(scene, camera); });
        log('AR gestartet');
      }catch(e){
        log('Start-Fehler: ' + e);
        alert('Start fehlgeschlagen: ' + e);
        startBtn.disabled = false;
      }
    });

    switchBtn.addEventListener('click', async ()=>{
      try{ await mindarThree.switchCamera(); log('Kamera gewechselt'); }
      catch(e){ log('switchCamera error: ' + e); }
    });

    addEventListener('resize', ()=>{ renderer.setSize(innerWidth, innerHeight); });
  </script>
</body>
</html>
