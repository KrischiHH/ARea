<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Image‑AR Viewer (Hotfix v2)</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:10}
    .box{background:#10131d;border:1px solid #2a3554;border-radius:14px;padding:18px;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:90vw}
    .btn{background:#2a60ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .hint{color:#cbd3ff;margin-top:8px;font-size:13px}
    .log{position:fixed;left:10px;bottom:10px;background:#10131d;border:1px solid #2a3554;border-radius:10px;padding:8px 10px;color:#cfd3df;font:12px ui-monospace;z-index:11;max-width:80vw;max-height:40vh;overflow:auto;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="overlay" id="gate">
    <div class="box">
      <div style="font-weight:700;margin-bottom:8px;">Image‑AR starten</div>
      <button class="btn" id="startBtn">Kamera aktivieren</button>
      <div class="hint">Tippe „Kamera aktivieren“, erlaube Zugriff, richte die Kamera auf das Target‑Bild.</div>
    </div>
  </div>
  <div class="log" id="log">Log:</div>

  <!-- WICHTIG: mindar-image schon im Markup setzen, damit das System existiert -->
  <a-scene id="scene" mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind" color-space="sRGB" renderer="colorManagement:true,physicallyCorrectLights" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">
    <a-assets id="assets"></a-assets>
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
    <a-entity id="target" mindar-image-target="targetIndex: 0"></a-entity>
  </a-scene>

  <script>
    const logEl = document.getElementById('log');
    const log = (m)=>{ console.log(m); logEl.textContent += "\n" + m; };
    function getSceneData(){ try{ const p=new URLSearchParams(location.search); const raw=decodeURIComponent(atob(p.get('scene')||'')); return JSON.parse(raw); } catch(e){ return null; } }
    const data = getSceneData();
    const sceneEl = document.querySelector('#scene');
    const targetEl = document.querySelector('#target');

    // Wenn .mind in der Szene angegeben ist, nachträglich setzen
    if (data?.anchor?.src && data.anchor.src.endsWith('.mind')) {
      sceneEl.setAttribute('mindar-image', 'imageTargetSrc: ' + data.anchor.src);
      log('mindar-image: override auf ' + data.anchor.src);
    } else {
      log('mindar-image: default target aktiv');
    }

    const defaultImg ="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png";
    const node=(data?.nodes&&data.nodes[0])||{id:"demo",type:"model",src:"https://modelviewer.dev/shared-assets/models/Astronaut.glb",transform:{position:[0,0,0],rotation:[0,0,0],scale:[0.5,0.5,0.5]}};

    const plane=document.createElement('a-plane'); plane.setAttribute('src', (data?.anchor?.src?.endsWith('.png')?data.anchor.src:defaultImg)); plane.setAttribute('height',0.552); plane.setAttribute('width',1); targetEl.appendChild(plane);
    const model=document.createElement('a-gltf-model'); model.setAttribute('src',node.src); model.setAttribute('position',(node.transform?.position||[0,0,0]).join(' ')); model.setAttribute('rotation',(node.transform?.rotation||[0,0,0]).join(' ')); model.setAttribute('scale',(node.transform?.scale||[0.5,0.5,0.5]).join(' ')); targetEl.appendChild(model);

    const gate = document.getElementById('gate');
    const start = async ()=>{
      try{
        const arSystem = sceneEl.systems['mindar-image-system'];
        if (!arSystem){ log('FEHLER: mindar-image-system nicht vorhanden'); alert('mindar-image-system fehlt (Attribut mindar-image?)'); return; }
        log('Starte AR…');
        await arSystem.start();
        gate.style.display = 'none';
        log('AR gestartet.');
      }catch(e){ log('Startfehler: ' + (e.message||e)); alert('Startfehler: ' + (e.message||e)); }
    };

    const ready = ()=>{
      log('Scene loaded.');
      document.getElementById('startBtn').onclick = ()=> start();
    };
    if (sceneEl.hasLoaded) ready();
    else sceneEl.addEventListener('loaded', ready);

    sceneEl.addEventListener('arReady', ()=> log('Tracking bereit'));
    sceneEl.addEventListener('arError', (e)=> log('AR Fehler: ' + (e.detail||'')) );
  </script>
</body>
</html>
