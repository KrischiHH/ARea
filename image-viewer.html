<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Image‑AR Viewer (Start‑Button)</title>
  <!-- Pin A‑Frame to a version known to work well with MindAR 1.2.5 -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:10}
    .box{background:#10131d;border:1px solid #2a3554;border-radius:14px;padding:18px;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:90vw}
    .btn{background:#2a60ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .hint{color:#cbd3ff;margin-top:8px;font-size:13px}
    .toast{position:fixed;left:10px;bottom:10px;background:#10131d;border:1px solid #2a3554;border-radius:10px;padding:8px 10px;color:#cfd3df;font:12px ui-monospace;z-index:11;display:none}
  </style>
</head>
<body>
  <div class="overlay" id="gate">
    <div class="box">
      <div style="font-weight:700;margin-bottom:8px;">Image‑AR starten</div>
      <button class="btn" id="startBtn">Kamera aktivieren</button>
      <div class="hint">Tippe „Kamera aktivieren“, erlaube Zugriff, richte die Kamera auf das Target‑Bild.</div>
    </div>
  </div>
  <div class="toast" id="toast"></div>

  <a-scene id="scene" color-space="sRGB" renderer="colorManagement:true,physicallyCorrectLights" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">
    <a-assets id="assets"></a-assets>
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
    <a-entity id="target" mindar-image-target="targetIndex: 0"></a-entity>
  </a-scene>

  <script>
    const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 4000); };
    function getSceneData(){ try{ const p=new URLSearchParams(location.search); const raw=decodeURIComponent(atob(p.get('scene')||'')); return JSON.parse(raw); } catch(e){ return null; } }
    const data = getSceneData();
    const sceneEl = document.querySelector('#scene');
    const targetEl = document.querySelector('#target');

    const defaultMind="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind";
    const defaultImg ="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png";

    const mindAttr = { imageTargetSrc: defaultMind };
    if (data?.anchor?.type==='image' && data.anchor.src && data.anchor.src.endsWith('.mind')) mindAttr.imageTargetSrc = data.anchor.src;
    sceneEl.setAttribute('mindar-image', Object.entries(mindAttr).map(([k,v])=>k+': '+v).join('; '));

    const node=(data?.nodes&&data.nodes[0])||{id:"demo",type:"model",src:"https://modelviewer.dev/shared-assets/models/Astronaut.glb",transform:{position:[0,0,0],rotation:[0,0,0],scale:[0.5,0.5,0.5]}};

    const plane=document.createElement('a-plane'); plane.setAttribute('src', (data?.anchor?.src?.endsWith('.png')?data.anchor.src:defaultImg)); plane.setAttribute('height',0.552); plane.setAttribute('width',1); targetEl.appendChild(plane);
    const model=document.createElement('a-gltf-model'); model.setAttribute('src',node.src); model.setAttribute('position',(node.transform?.position||[0,0,0]).join(' ')); model.setAttribute('rotation',(node.transform?.rotation||[0,0,0]).join(' ')); model.setAttribute('scale',(node.transform?.scale||[0.5,0.5,0.5]).join(' ')); targetEl.appendChild(model);

    // User-gesture gate for camera start
    const gate = document.getElementById('gate');
    const startBtn = document.getElementById('startBtn');
    sceneEl.addEventListener('loaded', ()=>{
      const arSystem = sceneEl.systems['mindar-image-system'];
      startBtn.onclick = async ()=>{
        try{
          await arSystem.start();
          gate.style.display = 'none';
          toast('AR gestartet');
        }catch(e){
          console.error(e);
          toast('Startfehler: ' + (e.message||e));
        }
      };
    });

    sceneEl.addEventListener('arReady', ()=> toast('Tracking bereit'));
    sceneEl.addEventListener('arError', (e)=> toast('AR Fehler: ' + (e.detail||'')) );
  </script>
</body>
</html>
